# qiankun微前端原理介绍

## 什么是微前端

微前端是一种多个团队通过独立发布功能的方式来共同构建现代化 web 应用的技术手段及方法策略。将前端应用分解成一些更小、更简单的能够独立开发、测试、部署的小块，而在用户看来仍然是内聚的单个产品。

我们先来粗略了解一下微前端项目的界面结构：

![简化图](./1.webp)

从上图可以明确地看到，微前端的主要布局可以分为三个部分：Header头部，菜单，以及子应用区域。

而我们要做的，就是通过切换菜单，然后再子应用区域切换为该菜单相应的子应用。

## 微前端的特点

* 技术栈独立 - 每个子应用都可以使用不同的框架、依赖等技术栈进行开发
* 独立开发，独立部署 - 每个子应用的仓库、开发、部署都是独立进行的，无需像其他web应用那样全量部署
* 沙箱隔离 - 每个应用之间的环境、状态、js、css相互隔离，运行时不共享不冲突

## 为什么不选择iframe

单看上面的概念和特点，有小伙伴可能会奇怪为什么不直接使用iframe，而是要搞那么多花里胡哨？

当然使用iframe也会有很多痛点，典型的有以下问题：

* url不同步 - iframe中的url与主体容器的url，这也意味着浏览器的前进后退无法直接响应iframe内的url
* DOM结构独立 - iframe与主体之间的DOM和JS脚本实则相互独立，最直接的例子就是假设从iframe的子模块中弹出一个带全局遮罩层的提示窗，显然它无法直接跨越iframe的界限展示在主体容器内
* 上下文隔离，全局环境和状态等不共享 - Cookie、LocalStrorage等或者其他一些状态值管理，除非处于同源，否则无法直接操作，当然也可以使用PostMessage处理这个问题，但这些方法不是效率不高就是具有局限性，特别是对于传递一些结构较为复杂的数据或直接传递一个函数的时候
* 同源策略问题 - 同源策略问题正如上一个痛点所说的，无疑加重了应用间的通信难度
* 加载缓慢 - 每个iframe实际上都是独立访问一个网站，访问多个网站的效率相比单独一个网站来说，显然是极其低效和不稳定的

问得好，其实确实有存在iframe的解决方案，那就是wujie。由于本次分享以qiankun为例，就不详细说wujie的解决这些问题的思路了，有兴趣的小伙伴可以自行去了解一下。

## qiankun的优势

| \          | qiankun                     | iframe                                     |
| ---------- | --------------------------- | ------------------------------------------ |
| 数据共享   | window                      | hash/query/LocalStorage(同源)/Cookie(同源) |
| 事件机制   | 私有通信机制                | PostMessage                                |
| 访问历史   | 全局统一，以主体容器url为准 | 主体容器及各应用各自隔离                   |
| 全局作用域 | 共享                        | 完全隔离                                   |
| CSS作用域  | 按需隔离                    | 完全隔离                                   |
| 资源价值   | 整体且快速，可预加载        | 独立且缓慢                                 |

qiankun在事件机制处理方式上，封装了一套私有的通信机制，各个应用间可通过封装好的API进行双向数据交互